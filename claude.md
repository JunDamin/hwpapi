# Claude's Guide to Working with hwpapi

This document captures critical knowledge, patterns, and best practices for working with the hwpapi codebase. Follow these guidelines to work effectively and avoid common pitfalls.

---

## üö® CRITICAL: nbdev Workflow - MUST READ FIRST

### The Golden Rule: NEVER Edit .py Files Directly

**ALL** Python files in `hwpapi/` are **AUTO-GENERATED** from Jupyter notebooks. Editing them directly will result in lost changes.

```
‚ùå WRONG: Edit hwpapi/parametersets.py
‚úÖ RIGHT: Edit nbs/02_api/02_parameters.ipynb, then run nbdev_export
```

### File Mapping (Notebook ‚Üí Python)

| Notebook | Generated Python File |
|----------|----------------------|
| `nbs/02_api/00_core.ipynb` | `hwpapi/core.py` |
| `nbs/02_api/01_actions.ipynb` | `hwpapi/actions.py` |
| `nbs/02_api/02_parameters.ipynb` | `hwpapi/parametersets.py` |
| `nbs/02_api/03_classes.ipynb` | `hwpapi/classes.py` |
| `nbs/02_api/04_constants.ipynb` | `hwpapi/constants.py` |
| `nbs/02_api/06_logging.ipynb` | `hwpapi/logging.py` |

### Correct Workflow for Code Changes

```bash
# 1. Identify the .py file that needs changes
# 2. Find corresponding .ipynb file (see mapping above)
# 3. Edit the notebook
# 4. Export to regenerate .py files
nbdev_export

# 5. Test your changes
python -m pytest tests/

# 6. Commit BOTH notebook and generated .py file
git add nbs/02_api/02_parameters.ipynb hwpapi/parametersets.py
git commit -m "Your change description"
```

### Warning Signs You're Doing It Wrong

- ‚ö†Ô∏è Editing a file with `# AUTOGENERATED! DO NOT EDIT!` at the top
- ‚ö†Ô∏è Changes disappear after running `nbdev_export`
- ‚ö†Ô∏è Notebook and .py file are out of sync

---

## üèóÔ∏è Architecture Deep Dive

### Core Design Patterns

#### 1. Backend Abstraction Pattern

The codebase uses multiple backends to handle different parameter set types:

```python
# Backend hierarchy
ParameterBackend (Protocol)
‚îú‚îÄ‚îÄ PsetBackend      # For pset objects (preferred, modern)
‚îú‚îÄ‚îÄ HParamBackend    # For HParameterSet (legacy)
‚îú‚îÄ‚îÄ ComBackend       # For generic COM objects
‚îî‚îÄ‚îÄ AttrBackend      # For plain Python objects
```

**Key Functions:**
- `_is_com(obj)` - Checks if object is COM (has `_oleobj_` or 'com_gen_py')
- `_looks_like_pset(obj)` - Checks for pset-specific methods (Item, SetItem, CreateItemSet)
- `make_backend(obj)` - Factory that auto-detects and returns appropriate backend

**Important**: Backend selection is automatic. Trust the factory function.

#### 2. Property Descriptor System

Type-safe properties with automatic validation and conversion:

```python
class CharShape(ParameterSet):
    bold = BoolProperty("Bold", "Bold formatting")
    fontsize = IntProperty("Size", "Font size in points")
    text_color = ColorProperty("TextColor", "Text color")
```

**Property Types:**
- `IntProperty` - Integer values
- `BoolProperty` - Boolean values
- `StringProperty` - String values
- `ColorProperty` - Hex color ‚Üî HWP color conversion
- `UnitProperty` - Point ‚Üî HWPUNIT conversion
- `MappedProperty` - String ‚Üî Integer via mapping dict
- `TypedProperty` - Nested ParameterSet
- `ListProperty` - List of values

**Auto-Generated Attributes:**
- `attributes_names` property returns `list(self._property_registry.keys())`
- ParameterSetMeta metaclass auto-populates `_property_registry`
- **NEVER** manually set `self.attributes_names = [...]` in subclasses

#### 3. Staging vs Immediate Mode

**Two execution modes:**

1. **Pset-based (Modern, Preferred)**
   - Changes apply immediately
   - No staging required
   - Simpler mental model

2. **HSet-based (Legacy)**
   - Changes are staged first
   - Must call `apply()` to commit
   - Supports transactional changes

**Code Pattern:**
```python
# Check backend type
if isinstance(self._backend, PsetBackend):
    # Immediate mode
else:
    # Staging mode - accumulate in self._staged
```

---

## üîç Common Issues and Solutions

### Issue 1: Missing Function Definitions

**Symptom:** `NameError: name '_is_com' is not defined`

**Cause:** Helper function used but not defined in notebook

**Solution:**
```python
# Add the missing function in the notebook with #| export
#| export

def _is_com(obj: Any) -> bool:
    """Check if object is a COM object."""
    if obj is None:
        return False
    return hasattr(obj, '_oleobj_') or 'com_gen_py' in str(type(obj))
```

### Issue 2: AttributeError with attributes_names

**Symptom:** `AttributeError: property 'attributes_names' of 'X' object has no setter`

**Cause:** Trying to set `self.attributes_names = [...]` after it became a read-only property

**Solution:** Define properties instead of setting attributes_names:
```python
# ‚ùå OLD WAY (broken)
class MyPS(ParameterSet):
    def __init__(self):
        super().__init__()
        self.attributes_names = ["a", "b"]
        self.a = None
        self.b = None

# ‚úÖ NEW WAY (correct)
class MyPS(ParameterSet):
    a = IntProperty("a", "Value a")
    b = IntProperty("b", "Value b")

    def __init__(self):
        super().__init__()
        # attributes_names auto-generated from properties
```

### Issue 3: Backend is None

**Symptom:** `AttributeError: 'NoneType' object has no attribute 'delete'`

**Cause:** Unbound ParameterSet (created without COM object)

**Solution:** Add None checks:
```python
def _del_value(self, name):
    """Legacy method - use backend instead."""
    if self._backend is None:
        return False
    return self._backend.delete(name)
```

### Issue 4: Import Errors Between Modules

**Symptom:** Circular import or missing imports

**Solution:** Check notebook cell order and exports:
- Functions used in cell N must be defined/imported in cells 1 to N-1
- Add `#| export` directive to export functions
- Use `from typing import TYPE_CHECKING` for type-only imports

---

## üõ†Ô∏è Simplification Strategies

### Successfully Applied Simplifications

#### ‚úÖ Auto-Generate attributes_names (Completed)

**Before:**
```python
class CharShape(ParameterSet):
    def __init__(self):
        super().__init__()
        self.attributes_names = [
            "facename_hangul", "facename_latin", ...,  # 67 lines!
        ]
```

**After:**
```python
# In ParameterSet base class
@property
def attributes_names(self):
    """Auto-generated list of attribute names from property registry."""
    return list(self._property_registry.keys())

# In subclasses - just define properties, no manual list!
class CharShape(ParameterSet):
    facename_hangul = StringProperty("FaceNameHangul", "...")
    facename_latin = StringProperty("FaceNameLatin", "...")
    # No self.attributes_names needed!
```

**Result:** Removed ~500 lines, eliminated maintenance burden

### Planned Simplifications (Priority Order)

#### Priority 1: Unify Backend Modes
- Remove dual staging behavior (immediate vs delayed)
- Pick one model and stick with it
- Impact: ~200 lines saved, 50% complexity reduction

#### Priority 2: Consolidate Property Types
- Replace 8 property classes with converter pattern
- Use `PropertyDescriptor("key", doc, converter=int)`
- Impact: ~200 lines saved, removes 6 classes

#### Priority 3: Remove Forward Declarations
- Use `TYPE_CHECKING` or reorder definitions
- Impact: ~25 lines saved, eliminates confusion

---

## üß™ Testing Strategy

### Test Structure

```
tests/test_hparam.py
‚îú‚îÄ‚îÄ Unit tests (with mocks) - Run without HWP
‚îú‚îÄ‚îÄ Integration tests - Require HWP installed
‚îî‚îÄ‚îÄ Graceful skipping - Tests skip if dependencies unavailable
```

### Running Tests

```bash
# All tests
python -m pytest tests/test_hparam.py -v

# Specific test class
python -m pytest tests/test_hparam.py::TestParameterSetUpdateFrom -v

# Show skipped tests
python -m pytest tests/test_hparam.py -v -ra
```

### Test Requirements

**For Unit Tests:** Just Python + pytest
**For Integration Tests:**
- Windows OS
- HWP installed
- pywin32

### Writing New Tests

```python
import unittest
from hwpapi.parametersets import ParameterSet, IntProperty

class TestMyFeature(unittest.TestCase):
    def test_feature(self):
        # Use real ParameterSet subclasses that have properties defined
        from hwpapi.parametersets import CharShape

        ps = CharShape()
        ps.bold = True
        self.assertEqual(ps.bold, True)
```

**Important:** When testing ParameterSet, use classes with actual property descriptors, not manual attributes_names lists.

---

## üìù Code Patterns to Follow

### Pattern 1: Adding a New ParameterSet Class

```python
#| export

class MyParameterSet(ParameterSet):
    """
    ### MyParameterSet

    123) MyParameterSet : ÎÇ¥ ÌååÎùºÎØ∏ÌÑ∞ÏÖã

    Description of what this parameter set does.
    """

    # Define properties (NOT attributes_names)
    my_int = IntProperty("MyInt", "Integer value")
    my_bool = BoolProperty("MyBool", "Boolean flag")
    my_color = ColorProperty("MyColor", "Color value")

    def __init__(self, parameterset=None, **kwargs):
        super().__init__(parameterset, **kwargs)
        # NO self.attributes_names = [...] needed!
        # Stage initial values if needed
        if 'my_int' in kwargs:
            self.my_int = kwargs['my_int']
```

### Pattern 2: Adding a New Property Type

```python
#| export

class MyProperty(PropertyDescriptor):
    """Custom property with special conversion."""

    def __get__(self, instance, owner):
        if instance is None:
            return self
        value = self._get_value(instance)
        if value is None:
            return self.default
        # Your conversion logic
        return my_conversion(value)

    def __set__(self, instance, value):
        if value is None:
            self._del_value(instance)
            return
        # Your validation logic
        converted = my_conversion(value)
        self._set_value(instance, converted)
```

### Pattern 3: Checking COM Objects

```python
# Always use the helper function
if _is_com(obj):
    # Handle COM object

# For pset specifically
if _looks_like_pset(obj):
    # Handle pset object

# Let factory decide
backend = make_backend(obj)  # Automatic detection
```

### Pattern 4: Handling Optional Backend

```python
def my_method(self):
    """Method that accesses backend."""
    if self._backend is None:
        # Handle unbound case
        return default_value

    # Proceed with backend operations
    return self._backend.get(self.key)
```

---

## üéØ Best Practices

### DO ‚úÖ

1. **Always edit notebooks, never .py files**
2. **Run `nbdev_export` after notebook changes**
3. **Test after every change** (at least run imports)
4. **Use property descriptors** for new ParameterSet attributes
5. **Check for None backend** in methods that access it
6. **Trust the backend factory** (make_backend)
7. **Follow existing patterns** in similar code
8. **Add `#| export` directive** to cells that should be exported
9. **Use type hints** (already set up with `from __future__ import annotations`)
10. **Keep backward compatibility** when refactoring

### DON'T ‚ùå

1. **DON'T edit .py files in hwpapi/ directly**
2. **DON'T set `self.attributes_names = [...]` in subclasses**
3. **DON'T assume backend is always present** (can be None)
4. **DON'T mix staging modes** without understanding
5. **DON'T add features without tests**
6. **DON'T break existing API** without migration path
7. **DON'T use `isinstance` checks** unless necessary
8. **DON'T forget to export** functions with `#| export`
9. **DON'T commit without running nbdev_export**
10. **DON'T create new COM detection logic** (use `_is_com`)

---

## üöÄ Development Workflow

### Making a Change (Step by Step)

```bash
# 1. Identify what needs changing
#    - Read the .py file to understand current code
#    - Find the corresponding .ipynb file

# 2. Edit the notebook
#    - Open nbs/02_api/XX_name.ipynb
#    - Make your changes in the appropriate cell
#    - Add #| export if creating new exported code

# 3. Export to Python
nbdev_export

# 4. Verify the generated code
#    - Check that hwpapi/*.py has your changes
#    - Look for any warnings or errors

# 5. Test your changes
python -c "import hwpapi; from hwpapi.parametersets import CharShape"
python -m pytest tests/test_hparam.py -v

# 6. Test in actual use (if possible)
python examples/your_example.py

# 7. Commit both files
git add nbs/02_api/XX_name.ipynb hwpapi/name.py
git commit -m "Description of change"
```

### Quick Verification Script

Save this as `verify_changes.sh`:
```bash
#!/bin/bash
echo "=== Running nbdev_export ==="
nbdev_export

echo -e "\n=== Testing imports ==="
python -c "import hwpapi; from hwpapi.parametersets import CharShape, BorderFill; print('‚úì Imports successful')"

echo -e "\n=== Running tests ==="
python -m pytest tests/test_hparam.py -v --tb=short

echo -e "\n=== Checking for common issues ==="
grep -r "self.attributes_names = \[" nbs/ && echo "‚ùå Found manual attributes_names!" || echo "‚úì No manual attributes_names"

echo -e "\n‚úÖ Verification complete!"
```

---

## üìö Key Reference Information

### Important Files

| File | Purpose |
|------|---------|
| `settings.ini` | nbdev configuration, version, metadata |
| `.clinerules` | Claude Code spec file (project overview) |
| `claude.md` | This file - working guidelines |
| `PSET_MIGRATION_SUMMARY.md` | Context on pset refactoring |
| `REFACTORING_SUMMARY.md` | Recent refactoring documentation |

### Key Classes

| Class | Location | Purpose |
|-------|----------|---------|
| `App` | `core.py` | High-level API for users |
| `Engine` | `core.py` | Mid-level wrapper around HwpObject |
| `ParameterSet` | `parametersets.py` | Base class for all parameter sets |
| `PropertyDescriptor` | `parametersets.py` | Base for property types |
| `ParameterSetMeta` | `parametersets.py` | Metaclass for auto-registration |

### Key Functions

| Function | Location | Purpose |
|----------|----------|---------|
| `_is_com(obj)` | `parametersets.py` | Check if object is COM |
| `_looks_like_pset(obj)` | `parametersets.py` | Check if object is pset |
| `make_backend(obj)` | `parametersets.py` | Create appropriate backend |
| `resolve_action_args()` | `parametersets.py` | Resolve action arguments |

### Environment Variables

```bash
HWPAPI_LOG_LEVEL=DEBUG    # Set logging level
```

---

## üêõ Debugging Tips

### Issue: Changes not appearing after nbdev_export

```bash
# Force re-export
rm hwpapi/*.py
nbdev_export

# Check for syntax errors in notebook
python -m nbformat.validate nbs/02_api/02_parameters.ipynb
```

### Issue: Import errors

```python
# Check what's exported
python -c "import hwpapi.parametersets; print(dir(hwpapi.parametersets))"

# Check __all__ in generated file
grep "__all__" hwpapi/parametersets.py
```

### Issue: Test failures

```bash
# Run with verbose output
python -m pytest tests/test_hparam.py -vv -s

# Run specific test
python -m pytest tests/test_hparam.py::TestClass::test_method -vv

# Show full traceback
python -m pytest tests/test_hparam.py --tb=long
```

### Issue: Notebook corruption

```bash
# Validate notebook JSON
python -m nbformat.validate nbs/02_api/02_parameters.ipynb

# If corrupted, restore from git
git checkout nbs/02_api/02_parameters.ipynb
```

---

## üí° Lessons Learned

### From Recent Simplifications

1. **Auto-generation beats manual maintenance**
   - `attributes_names` property eliminated 500+ lines
   - No sync issues between properties and attribute lists
   - Single source of truth (property registry)

2. **Property system is powerful**
   - Declarative is better than imperative
   - Type safety and validation in one place
   - Easier to extend and maintain

3. **Edge cases matter**
   - Always check for None backend
   - Handle unbound ParameterSets
   - Tests catch these issues

4. **nbdev workflow is non-negotiable**
   - NEVER edit .py files directly
   - Always export after notebook changes
   - Commit both notebook and generated code

5. **Simplification requires careful testing**
   - Changed behavior can break tests
   - Update tests to match new patterns
   - Verify with real usage, not just unit tests

### Pitfalls Encountered

1. ‚ùå Editing .py files ‚Üí Changes lost on next export
2. ‚ùå Setting `self.attributes_names` ‚Üí AttributeError (property has no setter)
3. ‚ùå Missing `_is_com` definition ‚Üí NameError
4. ‚ùå Not checking for None backend ‚Üí AttributeError
5. ‚ùå Manual attribute lists out of sync ‚Üí Runtime errors

---

## üéì Understanding the Domain

### HWP (Hancom Office)
- Korean word processor (like MS Word for Korea)
- COM automation via `HwpObject`
- Actions executed via `Run()` with parameter sets

### win32com Interface
- PyWin32 provides COM bridge
- COM objects have `_oleobj_` attribute
- Generated COM classes have 'com_gen_py' in type string

### Parameter Sets
- Configure HWP actions (like "InsertText", "FindReplace")
- Two flavors: pset (modern) and HSet (legacy)
- Properties map Python names to COM property names

---

## üìä Codebase Metrics

**Current State:**
- Total lines: ~15,000
- parametersets.py: ~4,100 lines
- ParameterSet subclasses: 29
- Property descriptors: 438
- Action definitions: 899+

**After Priority 2 Simplification:**
- Estimated: ~500 lines removed
- Maintenance burden: Significantly reduced
- Complexity: Much lower

---

## üîÑ Version History

### Recent Changes

**2024 - Auto-Generated attributes_names**
- Removed manual `self.attributes_names = [...]` from 9+ classes
- Added `@property attributes_names` to ParameterSet
- Fixed `_del_value` to handle None backend
- Updated tests to use property descriptors
- Result: -500 lines, eliminated sync issues

**2024 - Added _is_com Function**
- Fixed NameError in `_looks_like_pset`
- Added proper COM object detection
- Now properly distinguishes COM vs non-COM objects

**Earlier - Pset Migration**
- See PSET_MIGRATION_SUMMARY.md
- Migrated from HSet-based to pset-based approach
- Maintained backward compatibility

---

## ‚úÖ Checklist for New Contributors

Before making changes:
- [ ] Read this entire document
- [ ] Understand nbdev workflow (CRITICAL)
- [ ] Know the file mapping (notebook ‚Üí .py)
- [ ] Set up development environment
- [ ] Can run `nbdev_export` successfully
- [ ] Can run tests

Before committing:
- [ ] Edited notebook, NOT .py file
- [ ] Ran `nbdev_export`
- [ ] Ran tests (`python -m pytest tests/ -v`)
- [ ] Verified imports work
- [ ] Added/updated tests if needed
- [ ] Committing both .ipynb and .py files
- [ ] Commit message describes what and why

---

## üìû Quick Reference Commands

```bash
# Export notebooks to Python
nbdev_export

# Run all tests
python -m pytest tests/ -v

# Test specific module
python -m pytest tests/test_hparam.py -v

# Verify imports
python -c "import hwpapi; print('OK')"

# Check notebook validity
python -m nbformat.validate nbs/02_api/02_parameters.ipynb

# Generate documentation
nbdev_docs

# Clean generated files
nbdev_clean

# Preview documentation
nbdev_preview
```

---

## üéØ Remember

1. **This is nbdev**: Source is in notebooks, .py files are generated
2. **Backend abstraction works**: Trust `make_backend()` factory
3. **Properties are auto-registered**: No manual `attributes_names` needed
4. **Always check for None**: Backend might not be initialized
5. **Test your changes**: Don't break existing functionality
6. **Keep it simple**: Prefer simplification over clever abstractions
7. **Document decisions**: Update this file when you learn something new

---

*This document is a living guide. Update it as you learn more about the codebase.*

**Last Updated:** 2024 (After attributes_names simplification)
**Next Review:** After Priority 1 simplification (unify backend modes)
