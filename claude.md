# Claude's Guide to Working with hwpapi

This document captures critical knowledge, patterns, and best practices for working with the hwpapi codebase. Follow these guidelines to work effectively and avoid common pitfalls.

---

## ğŸš¨ CRITICAL: nbdev Workflow - MUST READ FIRST

### The Golden Rule: NEVER Edit .py Files Directly

**ALL** Python files in `hwpapi/` are **AUTO-GENERATED** from Jupyter notebooks. Editing them directly will result in lost changes.

```
âŒ WRONG: Edit hwpapi/parametersets.py
âœ… RIGHT: Edit nbs/02_api/02_parameters.ipynb, then run nbdev_export
```

### File Mapping (Notebook â†’ Python)

| Notebook | Generated Python File |
|----------|----------------------|
| `nbs/02_api/00_core.ipynb` | `hwpapi/core.py` |
| `nbs/02_api/01_actions.ipynb` | `hwpapi/actions.py` |
| `nbs/02_api/02_parameters.ipynb` | `hwpapi/parametersets.py` |
| `nbs/02_api/03_classes.ipynb` | `hwpapi/classes.py` |
| `nbs/02_api/04_constants.ipynb` | `hwpapi/constants.py` |
| `nbs/02_api/06_logging.ipynb` | `hwpapi/logging.py` |

### Correct Workflow for Code Changes

```bash
# 1. Identify the .py file that needs changes
# 2. Find corresponding .ipynb file (see mapping above)
# 3. Edit the notebook
# 4. Export to regenerate .py files
nbdev_export

# 5. Test your changes
python -m pytest tests/

# 6. Commit BOTH notebook and generated .py file
git add nbs/02_api/02_parameters.ipynb hwpapi/parametersets.py
git commit -m "Your change description"
```

### Warning Signs You're Doing It Wrong

- âš ï¸ Editing a file with `# AUTOGENERATED! DO NOT EDIT!` at the top
- âš ï¸ Changes disappear after running `nbdev_export`
- âš ï¸ Notebook and .py file are out of sync

---

## ğŸ—ï¸ Architecture Deep Dive

### Core Design Patterns

#### 1. Backend Abstraction Pattern

The codebase uses multiple backends to handle different parameter set types:

```python
# Backend hierarchy
ParameterBackend (Protocol)
â”œâ”€â”€ PsetBackend      # For pset objects (preferred, modern)
â”œâ”€â”€ HParamBackend    # For HParameterSet (legacy)
â”œâ”€â”€ ComBackend       # For generic COM objects
â””â”€â”€ AttrBackend      # For plain Python objects
```

**Key Functions:**
- `_is_com(obj)` - Checks if object is COM (has `_oleobj_` or 'com_gen_py')
- `_looks_like_pset(obj)` - Checks for pset-specific methods (Item, SetItem, CreateItemSet)
- `make_backend(obj)` - Factory that auto-detects and returns appropriate backend

**Important**: Backend selection is automatic. Trust the factory function.

#### 2. Property Descriptor System

Type-safe properties with automatic validation and conversion:

```python
class CharShape(ParameterSet):
    bold = BoolProperty("Bold", "Bold formatting")
    fontsize = IntProperty("Size", "Font size in points")
    text_color = ColorProperty("TextColor", "Text color")
```

**Property Types:**
- `IntProperty` - Integer values
- `BoolProperty` - Boolean values
- `StringProperty` - String values
- `ColorProperty` - Hex color â†” HWP color conversion
- `UnitProperty` - Point â†” HWPUNIT conversion
- `MappedProperty` - String â†” Integer via mapping dict
- `TypedProperty` - Nested ParameterSet
- `ListProperty` - List of values

**Auto-Generated Attributes:**
- `attributes_names` property returns `list(self._property_registry.keys())`
- ParameterSetMeta metaclass auto-populates `_property_registry`
- **NEVER** manually set `self.attributes_names = [...]` in subclasses

#### 3. Staging vs Immediate Mode

**Two execution modes:**

1. **Pset-based (Modern, Preferred)**
   - Changes apply immediately
   - No staging required
   - Simpler mental model

2. **HSet-based (Legacy)**
   - Changes are staged first
   - Must call `apply()` to commit
   - Supports transactional changes

**Code Pattern:**
```python
# Check backend type
if isinstance(self._backend, PsetBackend):
    # Immediate mode
else:
    # Staging mode - accumulate in self._staged
```

---

## ğŸ” Common Issues and Solutions

### Issue 1: Missing Function Definitions

**Symptom:** `NameError: name '_is_com' is not defined`

**Cause:** Helper function used but not defined in notebook

**Solution:**
```python
# Add the missing function in the notebook with #| export
#| export

def _is_com(obj: Any) -> bool:
    """Check if object is a COM object."""
    if obj is None:
        return False
    return hasattr(obj, '_oleobj_') or 'com_gen_py' in str(type(obj))
```

### Issue 2: AttributeError with attributes_names

**Symptom:** `AttributeError: property 'attributes_names' of 'X' object has no setter`

**Cause:** Trying to set `self.attributes_names = [...]` after it became a read-only property

**Solution:** Define properties instead of setting attributes_names:
```python
# âŒ OLD WAY (broken)
class MyPS(ParameterSet):
    def __init__(self):
        super().__init__()
        self.attributes_names = ["a", "b"]
        self.a = None
        self.b = None

# âœ… NEW WAY (correct)
class MyPS(ParameterSet):
    a = IntProperty("a", "Value a")
    b = IntProperty("b", "Value b")

    def __init__(self):
        super().__init__()
        # attributes_names auto-generated from properties
```

### Issue 3: Backend is None

**Symptom:** `AttributeError: 'NoneType' object has no attribute 'delete'`

**Cause:** Unbound ParameterSet (created without COM object)

**Solution:** Add None checks:
```python
def _del_value(self, name):
    """Legacy method - use backend instead."""
    if self._backend is None:
        return False
    return self._backend.delete(name)
```

### Issue 4: Import Errors Between Modules

**Symptom:** Circular import or missing imports

**Solution:** Check notebook cell order and exports:
- Functions used in cell N must be defined/imported in cells 1 to N-1
- Add `#| export` directive to export functions
- Use `from typing import TYPE_CHECKING` for type-only imports

---

## ğŸ› ï¸ Simplification Strategies

### Successfully Applied Simplifications

#### âœ… Auto-Generate attributes_names (Completed)

**Before:**
```python
class CharShape(ParameterSet):
    def __init__(self):
        super().__init__()
        self.attributes_names = [
            "facename_hangul", "facename_latin", ...,  # 67 lines!
        ]
```

**After:**
```python
# In ParameterSet base class
@property
def attributes_names(self):
    """Auto-generated list of attribute names from property registry."""
    return list(self._property_registry.keys())

# In subclasses - just define properties, no manual list!
class CharShape(ParameterSet):
    facename_hangul = StringProperty("FaceNameHangul", "...")
    facename_latin = StringProperty("FaceNameLatin", "...")
    # No self.attributes_names needed!
```

**Result:** Removed ~500 lines, eliminated maintenance burden

### Planned Simplifications (Priority Order)

#### Priority 1: Unify Backend Modes
- Remove dual staging behavior (immediate vs delayed)
- Pick one model and stick with it
- Impact: ~200 lines saved, 50% complexity reduction

#### Priority 2: Consolidate Property Types
- Replace 8 property classes with converter pattern
- Use `PropertyDescriptor("key", doc, converter=int)`
- Impact: ~200 lines saved, removes 6 classes

#### Priority 3: Remove Forward Declarations
- Use `TYPE_CHECKING` or reorder definitions
- Impact: ~25 lines saved, eliminates confusion

---

## ğŸ§ª Testing Strategy

### Test Structure

```
tests/test_hparam.py
â”œâ”€â”€ Unit tests (with mocks) - Run without HWP
â”œâ”€â”€ Integration tests - Require HWP installed
â””â”€â”€ Graceful skipping - Tests skip if dependencies unavailable
```

### Running Tests

```bash
# All tests
python -m pytest tests/test_hparam.py -v

# Specific test class
python -m pytest tests/test_hparam.py::TestParameterSetUpdateFrom -v

# Show skipped tests
python -m pytest tests/test_hparam.py -v -ra
```

### Test Requirements

**For Unit Tests:** Just Python + pytest
**For Integration Tests:**
- Windows OS
- HWP installed
- pywin32

### Writing New Tests

```python
import unittest
from hwpapi.parametersets import ParameterSet, IntProperty

class TestMyFeature(unittest.TestCase):
    def test_feature(self):
        # Use real ParameterSet subclasses that have properties defined
        from hwpapi.parametersets import CharShape

        ps = CharShape()
        ps.bold = True
        self.assertEqual(ps.bold, True)
```

**Important:** When testing ParameterSet, use classes with actual property descriptors, not manual attributes_names lists.

---

## ğŸ“ Code Patterns to Follow

### Pattern 1: Adding a New ParameterSet Class

```python
#| export

class MyParameterSet(ParameterSet):
    """
    ### MyParameterSet

    123) MyParameterSet : ë‚´ íŒŒë¼ë¯¸í„°ì…‹

    Description of what this parameter set does.
    """

    # Define properties (NOT attributes_names)
    my_int = IntProperty("MyInt", "Integer value")
    my_bool = BoolProperty("MyBool", "Boolean flag")
    my_color = ColorProperty("MyColor", "Color value")

    def __init__(self, parameterset=None, **kwargs):
        super().__init__(parameterset, **kwargs)
        # NO self.attributes_names = [...] needed!
        # Stage initial values if needed
        if 'my_int' in kwargs:
            self.my_int = kwargs['my_int']
```

### Pattern 2: Adding a New Property Type

```python
#| export

class MyProperty(PropertyDescriptor):
    """Custom property with special conversion."""

    def __get__(self, instance, owner):
        if instance is None:
            return self
        value = self._get_value(instance)
        if value is None:
            return self.default
        # Your conversion logic
        return my_conversion(value)

    def __set__(self, instance, value):
        if value is None:
            self._del_value(instance)
            return
        # Your validation logic
        converted = my_conversion(value)
        self._set_value(instance, converted)
```

### Pattern 3: Checking COM Objects

```python
# Always use the helper function
if _is_com(obj):
    # Handle COM object

# For pset specifically
if _looks_like_pset(obj):
    # Handle pset object

# Let factory decide
backend = make_backend(obj)  # Automatic detection
```

### Pattern 4: Handling Optional Backend

```python
def my_method(self):
    """Method that accesses backend."""
    if self._backend is None:
        # Handle unbound case
        return default_value

    # Proceed with backend operations
    return self._backend.get(self.key)
```

---

## ğŸ¯ Best Practices

### DO âœ…

1. **Always edit notebooks, never .py files**
2. **Run `nbdev_export` after notebook changes**
3. **Test after every change** (at least run imports)
4. **Use property descriptors** for new ParameterSet attributes
5. **Check for None backend** in methods that access it
6. **Trust the backend factory** (make_backend)
7. **Follow existing patterns** in similar code
8. **Add `#| export` directive** to cells that should be exported
9. **Use type hints** (already set up with `from __future__ import annotations`)
10. **Keep backward compatibility** when refactoring

### DON'T âŒ

1. **DON'T edit .py files in hwpapi/ directly**
2. **DON'T set `self.attributes_names = [...]` in subclasses**
3. **DON'T assume backend is always present** (can be None)
4. **DON'T mix staging modes** without understanding
5. **DON'T add features without tests**
6. **DON'T break existing API** without migration path
7. **DON'T use `isinstance` checks** unless necessary
8. **DON'T forget to export** functions with `#| export`
9. **DON'T commit without running nbdev_export**
10. **DON'T create new COM detection logic** (use `_is_com`)

---

## ğŸš€ Development Workflow

### Making a Change (Step by Step)

```bash
# 1. Identify what needs changing
#    - Read the .py file to understand current code
#    - Find the corresponding .ipynb file

# 2. Edit the notebook
#    - Open nbs/02_api/XX_name.ipynb
#    - Make your changes in the appropriate cell
#    - Add #| export if creating new exported code

# 3. Export to Python
nbdev_export

# 4. Verify the generated code
#    - Check that hwpapi/*.py has your changes
#    - Look for any warnings or errors

# 5. Test your changes
python -c "import hwpapi; from hwpapi.parametersets import CharShape"
python -m pytest tests/test_hparam.py -v

# 6. Test in actual use (if possible)
python examples/your_example.py

# 7. Commit both files
git add nbs/02_api/XX_name.ipynb hwpapi/name.py
git commit -m "Description of change"
```

### Quick Verification Script

Save this as `verify_changes.sh`:
```bash
#!/bin/bash
echo "=== Running nbdev_export ==="
nbdev_export

echo -e "\n=== Testing imports ==="
python -c "import hwpapi; from hwpapi.parametersets import CharShape, BorderFill; print('âœ“ Imports successful')"

echo -e "\n=== Running tests ==="
python -m pytest tests/test_hparam.py -v --tb=short

echo -e "\n=== Checking for common issues ==="
grep -r "self.attributes_names = \[" nbs/ && echo "âŒ Found manual attributes_names!" || echo "âœ“ No manual attributes_names"

echo -e "\nâœ… Verification complete!"
```

---

## ğŸ“š Key Reference Information

### Important Files

| File | Purpose |
|------|---------|
| `settings.ini` | nbdev configuration, version, metadata |
| `.clinerules` | Claude Code spec file (project overview) |
| `claude.md` | This file - working guidelines |
| `PSET_MIGRATION_SUMMARY.md` | Context on pset refactoring |
| `REFACTORING_SUMMARY.md` | Recent refactoring documentation |

### Key Classes

| Class | Location | Purpose |
|-------|----------|---------|
| `App` | `core.py` | High-level API for users |
| `Engine` | `core.py` | Mid-level wrapper around HwpObject |
| `ParameterSet` | `parametersets.py` | Base class for all parameter sets |
| `PropertyDescriptor` | `parametersets.py` | Base for property types |
| `ParameterSetMeta` | `parametersets.py` | Metaclass for auto-registration |

### Key Functions

| Function | Location | Purpose |
|----------|----------|---------|
| `_is_com(obj)` | `parametersets.py` | Check if object is COM |
| `_looks_like_pset(obj)` | `parametersets.py` | Check if object is pset |
| `make_backend(obj)` | `parametersets.py` | Create appropriate backend |
| `resolve_action_args()` | `parametersets.py` | Resolve action arguments |

### Environment Variables

```bash
HWPAPI_LOG_LEVEL=DEBUG    # Set logging level
```

---

## ğŸ› Debugging Tips

### Issue: Changes not appearing after nbdev_export

```bash
# Force re-export
rm hwpapi/*.py
nbdev_export

# Check for syntax errors in notebook
python -m nbformat.validate nbs/02_api/02_parameters.ipynb
```

### Issue: Import errors

```python
# Check what's exported
python -c "import hwpapi.parametersets; print(dir(hwpapi.parametersets))"

# Check __all__ in generated file
grep "__all__" hwpapi/parametersets.py
```

### Issue: Test failures

```bash
# Run with verbose output
python -m pytest tests/test_hparam.py -vv -s

# Run specific test
python -m pytest tests/test_hparam.py::TestClass::test_method -vv

# Show full traceback
python -m pytest tests/test_hparam.py --tb=long
```

### Issue: Notebook corruption

```bash
# Validate notebook JSON
python -m nbformat.validate nbs/02_api/02_parameters.ipynb

# If corrupted, restore from git
git checkout nbs/02_api/02_parameters.ipynb
```

---

## ğŸ’¡ Lessons Learned

### From Recent Simplifications

1. **Auto-generation beats manual maintenance**
   - `attributes_names` property eliminated 500+ lines
   - No sync issues between properties and attribute lists
   - Single source of truth (property registry)

2. **Property system is powerful**
   - Declarative is better than imperative
   - Type safety and validation in one place
   - Easier to extend and maintain

3. **Edge cases matter**
   - Always check for None backend
   - Handle unbound ParameterSets
   - Tests catch these issues

4. **nbdev workflow is non-negotiable**
   - NEVER edit .py files directly
   - Always export after notebook changes
   - Commit both notebook and generated code

5. **Simplification requires careful testing**
   - Changed behavior can break tests
   - Update tests to match new patterns
   - Verify with real usage, not just unit tests

### Pitfalls Encountered

1. âŒ Editing .py files â†’ Changes lost on next export
2. âŒ Setting `self.attributes_names` â†’ AttributeError (property has no setter)
3. âŒ Missing `_is_com` definition â†’ NameError
4. âŒ Not checking for None backend â†’ AttributeError
5. âŒ Manual attribute lists out of sync â†’ Runtime errors

---

## ğŸ“ Understanding the Domain

### HWP (Hancom Office)
- Korean word processor (like MS Word for Korea)
- COM automation via `HwpObject`
- Actions executed via `Run()` with parameter sets

### win32com Interface
- PyWin32 provides COM bridge
- COM objects have `_oleobj_` attribute
- Generated COM classes have 'com_gen_py' in type string

### Parameter Sets
- Configure HWP actions (like "InsertText", "FindReplace")
- Two flavors: pset (modern) and HSet (legacy)
- Properties map Python names to COM property names

---

## ğŸ“Š Codebase Metrics

**Current State:**
- Total lines: ~15,000
- parametersets.py: ~4,100 lines
- ParameterSet subclasses: 29
- Property descriptors: 438
- Action definitions: 899+

**After Priority 2 Simplification:**
- Estimated: ~500 lines removed
- Maintenance burden: Significantly reduced
- Complexity: Much lower

---

## ğŸ›ï¸ HWP Object Model: Official vs Current Architecture

### Overview

This section compares the **official HWP Automation Object Model** (from HwpAutomation_2504.pdf) with the **current hwpapi implementation** to identify gaps, misalignments, and opportunities for better code organization.

**Documentation Source:** `hwp_docs/HwpAutomation_2504.pdf` (Korean, dated 2025-04-15)

---

### Official HWP Object Model Structure

The official HWP automation follows a **hierarchical object model** similar to Microsoft Office:

```
IHwpObject (Root COM Object)
â”‚
â”œâ”€â”€ IXHwpDocuments (Collection)
â”‚   â””â”€â”€ IXHwpDocument (Single)
â”‚       â”œâ”€â”€ Properties: FullName, Name, Path, Saved, etc.
â”‚       â””â”€â”€ Methods: Save(), SaveAs(), Close(), Print(), etc.
â”‚
â”œâ”€â”€ IXHwpWindows (Collection)
â”‚   â””â”€â”€ IXHwpWindow (Single)
â”‚       â”œâ”€â”€ Properties: Width, Height, Left, Top, Active, etc.
â”‚       â””â”€â”€ Methods: Activate(), Close(), etc.
â”‚
â”œâ”€â”€ IXHwpForms (Collection)
â”‚   â””â”€â”€ Form Controls (Various types)
â”‚       â”œâ”€â”€ IXHwpFormPushButtons (Collection)
â”‚       â”œâ”€â”€ IXHwpFormCheckButtons (Collection)
â”‚       â”œâ”€â”€ IXHwpFormRadioButtons (Collection)
â”‚       â”œâ”€â”€ IXHwpFormComboBoxes (Collection)
â”‚       â””â”€â”€ etc.
â”‚
â”œâ”€â”€ HAction (Action Execution System)
â”‚   â”œâ”€â”€ GetActionIDByName(name) â†’ ActionID
â”‚   â”œâ”€â”€ Run(ActionID)
â”‚   â””â”€â”€ Execute(ActionID, ParameterSet)
â”‚
â”œâ”€â”€ HParameterSet (Parameter Management)
â”‚   â”œâ”€â”€ CreateItemSet(SetID, ParamIndex)
â”‚   â”œâ”€â”€ Item(ParamIndex)
â”‚   â”œâ”€â”€ SetItem(ParamIndex, Value)
â”‚   â””â”€â”€ Clear()
â”‚
â”œâ”€â”€ HSet (Parameter Collection)
â”‚   â””â”€â”€ Parameter arrays for complex actions
â”‚
â””â”€â”€ HArray (Parameter Arrays)
    â””â”€â”€ Multi-value parameters
```

**Key Characteristics:**
1. **Collection Pattern**: Documents, Windows, Forms follow "Collection â†’ Single Object" pattern
2. **Hierarchical Navigation**: Document â†’ Sections â†’ Paragraphs â†’ Characters
3. **Action System**: Centralized via HAction.Execute() with HParameterSet
4. **900+ Actions**: Each with specific parameter requirements
5. **Type-Safe Parameters**: Strongly typed via HParameterSet interface

---

### Current hwpapi Architecture

The current implementation uses a **wrapper-based approach** with custom patterns:

```
App (Main Entry Point)
â”‚
â”œâ”€â”€ Engine
â”‚   â””â”€â”€ impl (HwpObject COM object)
â”‚       â””â”€â”€ Direct COM access: self.api.MovePos(), self.api.Run(), etc.
â”‚
â”œâ”€â”€ _Actions (900+ actions as properties)
â”‚   â”œâ”€â”€ CharShape â†’ _Action("CharShape", CharShape parameterset)
â”‚   â”œâ”€â”€ ParaShape â†’ _Action("ParaShape", ParaShape parameterset)
â”‚   â””â”€â”€ [899+ more actions...]
â”‚
â”œâ”€â”€ ParameterSet System (130+ classes in parametersets.py)
â”‚   â”œâ”€â”€ Base: ParameterSet, ParameterSetMeta
â”‚   â”œâ”€â”€ Backend Abstraction:
â”‚   â”‚   â”œâ”€â”€ PsetBackend (modern, immediate)
â”‚   â”‚   â”œâ”€â”€ HParamBackend (legacy, staging)
â”‚   â”‚   â”œâ”€â”€ ComBackend (generic COM)
â”‚   â”‚   â””â”€â”€ AttrBackend (pure Python)
â”‚   â”œâ”€â”€ Property Descriptors:
â”‚   â”‚   â”œâ”€â”€ IntProperty, BoolProperty, StringProperty
â”‚   â”‚   â”œâ”€â”€ ColorProperty, UnitProperty
â”‚   â”‚   â”œâ”€â”€ MappedProperty, TypedProperty, ListProperty
â”‚   â”‚   â””â”€â”€ Auto-registration via ParameterSetMeta
â”‚   â””â”€â”€ 130+ ParameterSet Subclasses:
â”‚       â”œâ”€â”€ Text/Char: CharShape, ParaShape, BulletShape, etc.
â”‚       â”œâ”€â”€ Tables: Table, Cell, TableCreation, etc.
â”‚       â”œâ”€â”€ Drawing: ShapeObject, DrawLineAttr, DrawImageAttr, etc.
â”‚       â”œâ”€â”€ Document: DocumentInfo, PageDef, SecDef, etc.
â”‚       â””â”€â”€ [All mixed in single 3,357-line file]
â”‚
â”œâ”€â”€ Custom Accessors (Pythonic convenience layer)
â”‚   â”œâ”€â”€ MoveAccessor: Navigation (move.top_of_file(), move.bottom(), etc.)
â”‚   â”œâ”€â”€ CellAccessor: Table cell operations
â”‚   â”œâ”€â”€ TableAccessor: Table operations
â”‚   â””â”€â”€ PageAccessor: Page operations
â”‚
â””â”€â”€ Dataclasses (Alternative representation)
    â”œâ”€â”€ Character, CharShape (dataclass)
    â”œâ”€â”€ Paragraph, ParaShape (dataclass)
    â””â”€â”€ PageShape (dataclass)
```

**Key Characteristics:**
1. **Flat Entry Point**: Single `App` object, no collections exposed
2. **Action Properties**: 900+ actions as dynamic properties on `_Actions`
3. **Backend Polymorphism**: 4 backend types handle different parameter storage
4. **Pythonic Wrappers**: Custom accessors hide COM complexity
5. **Monolithic ParameterSets**: All 130+ classes in one file

---

### Comparison Matrix

| Aspect | Official HWP Model | Current hwpapi | Alignment |
|--------|-------------------|----------------|-----------|
| **Entry Point** | `IHwpObject` COM object | `App` wrapper around `Engine` | âœ… Aligned (wrapped) |
| **Document Access** | `IXHwpDocuments` collection | `App.api` direct access | âŒ Collection pattern not exposed |
| **Window Management** | `IXHwpWindows` collection | `App.set_visible()` only | âš ï¸ Partial (no multi-window support) |
| **Form Controls** | `IXHwpForms` collection | Not exposed | âŒ Missing |
| **Action Execution** | `HAction.Execute(id, pset)` | `app.actions.ActionName(pset)` | âœ… Aligned (pythonic wrapper) |
| **Parameter Sets** | `HParameterSet` COM object | `ParameterSet` Python classes | âœ… Well abstracted |
| **Parameter Typing** | COM types | Python property descriptors | âœ… Excellent (better than COM) |
| **Navigation** | Object hierarchy | Custom accessors | âš ï¸ Different paradigm |
| **Organization** | Domain-based modules | Single monolithic file | âŒ Poor organization |

---

### Identified Gaps and Misalignments

#### 1. Missing Collection Objects âŒ

**Issue:** hwpapi doesn't expose collection objects like `IXHwpDocuments`, `IXHwpWindows`, `IXHwpForms`

**Impact:**
- Cannot enumerate open documents
- Cannot manage multiple windows
- No access to form controls
- Limits multi-document workflows

**Example (What's Missing):**
```python
# This is possible in official HWP but not in hwpapi:
documents = hwp.Documents  # Collection of all open documents
doc = documents.Item(0)    # Get first document
doc.Save()                 # Save specific document
```

**Current hwpapi:**
```python
# Only single document access:
app = App()  # Always refers to "current" document
app.save()   # Saves "current" document only
```

#### 2. Monolithic ParameterSets Module âŒ

**Issue:** All 130+ ParameterSet classes crammed into single 3,357-line file

**Impact:**
- Hard to navigate and maintain
- No logical grouping by domain
- Merge conflicts in team development
- Slow IDE performance

**Breakdown:**
```
parametersets.py (3,357 lines):
â”œâ”€â”€ Mappings (147 lines): All DIRECTION_MAP, ALIGNMENT_MAP, etc.
â”œâ”€â”€ Backend System (350 lines): Protocols, backend classes
â”œâ”€â”€ Property Descriptors (250 lines): IntProperty, BoolProperty, etc.
â”œâ”€â”€ ParameterSet Base (150 lines): Base class, metaclass
â””â”€â”€ 130+ ParameterSet Classes (2,460 lines):
    â”œâ”€â”€ Text/Character (15 classes): CharShape, ParaShape, BulletShape, etc.
    â”œâ”€â”€ Tables (12 classes): Table, Cell, TableCreation, etc.
    â”œâ”€â”€ Drawing/Shapes (25 classes): ShapeObject, DrawLineAttr, etc.
    â”œâ”€â”€ Document (18 classes): DocumentInfo, PageDef, SecDef, etc.
    â”œâ”€â”€ Find/Replace (5 classes): FindReplace, DocFindInfo, etc.
    â”œâ”€â”€ Forms (8 classes): AutoFill, AutoNum, FieldCtrl, etc.
    â”œâ”€â”€ Formatting (12 classes): BorderFill, Caption, DropCap, etc.
    â”œâ”€â”€ Actions (15 classes): FileOpen, FileSaveAs, Print, etc.
    â””â”€â”€ Misc (20 classes): Everything else
```

#### 3. Navigation Paradigm Mismatch âš ï¸

**Issue:** Official model uses object hierarchy, hwpapi uses position-based accessors

**Official Model (Object-Based):**
```python
# Hypothetical object-based navigation:
document = app.ActiveDocument
section = document.Sections[0]
paragraph = section.Paragraphs[5]
text = paragraph.Text
```

**Current hwpapi (Position-Based):**
```python
# Position-based navigation:
app.move.current_list(para=5, pos=0)
app.actions.CharShape(...)
```

**Analysis:** Current approach is more pragmatic for HWP's position-based model. No change needed.

#### 4. Form Controls Not Exposed âŒ

**Issue:** No access to IXHwpForms, form button controls, etc.

**Impact:**
- Cannot automate form-based documents
- Cannot create interactive PDFs with forms
- Missing feature parity with official API

---

### Proposed Restructuring Plan

#### Phase 1: Reorganize ParameterSets Module (High Priority)

**Goal:** Split monolithic `parametersets.py` into domain-based submodules

**New Structure:**
```
hwpapi/
â”œâ”€â”€ parametersets/
â”‚   â”œâ”€â”€ __init__.py              # Re-export all classes for compatibility
â”‚   â”œâ”€â”€ base.py                  # ParameterSet base class, metaclass
â”‚   â”œâ”€â”€ backends.py              # Backend protocol, implementations
â”‚   â”œâ”€â”€ properties.py            # Property descriptors
â”‚   â”œâ”€â”€ mappings.py              # All DIRECTION_MAP, ALIGNMENT_MAP, etc.
â”‚   â”œâ”€â”€ text/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ character.py         # CharShape, BulletShape
â”‚   â”‚   â”œâ”€â”€ paragraph.py         # ParaShape, TabDef, ListProperties
â”‚   â”‚   â””â”€â”€ numbering.py         # NumberingShape, AutoNum
â”‚   â”œâ”€â”€ table/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ table.py             # Table, TableCreation
â”‚   â”‚   â””â”€â”€ cell.py              # Cell, CellBorderFill
â”‚   â”œâ”€â”€ drawing/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ shape.py             # ShapeObject, DrawLayout
â”‚   â”‚   â”œâ”€â”€ line.py              # DrawLineAttr
â”‚   â”‚   â”œâ”€â”€ image.py             # DrawImageAttr, DrawImageScissoring
â”‚   â”‚   â””â”€â”€ effects.py           # DrawShadow, DrawRotate, DrawTextart
â”‚   â”œâ”€â”€ document/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ info.py              # DocumentInfo, SummaryInfo, VersionInfo
â”‚   â”‚   â”œâ”€â”€ page.py              # PageDef, PageBorderFill, MasterPage
â”‚   â”‚   â””â”€â”€ section.py           # SecDef, ColDef
â”‚   â”œâ”€â”€ formatting/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ border.py            # BorderFill, BorderFillExt
â”‚   â”‚   â”œâ”€â”€ caption.py           # Caption, FootnoteShape
â”‚   â”‚   â””â”€â”€ style.py             # Style, StyleTemplate
â”‚   â”œâ”€â”€ actions/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ file.py              # FileOpen, FileSaveAs, FileConvert
â”‚   â”‚   â”œâ”€â”€ edit.py              # FindReplace, ConvertCase, etc.
â”‚   â”‚   â””â”€â”€ print.py             # Print, PrintToImage, PrintWatermark
â”‚   â””â”€â”€ forms/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ fields.py            # AutoFill, FieldCtrl, HyperLink
```

**Benefits:**
- **Maintainability**: Find CharShape in `text/character.py`, not line 850 of monolith
- **Team Development**: Fewer merge conflicts with separated files
- **IDE Performance**: Faster autocomplete, syntax highlighting
- **Logical Grouping**: Related classes together by domain
- **Backward Compatible**: Re-export from `__init__.py` preserves existing imports

**Migration:**
```python
# Old import (still works):
from hwpapi.parametersets import CharShape, ParaShape, Table

# New import (also works):
from hwpapi.parametersets.text.character import CharShape
from hwpapi.parametersets.text.paragraph import ParaShape
from hwpapi.parametersets.table.table import Table
```

**Estimated Impact:**
- Lines reduced: 0 (reorganization, not deletion)
- Files created: ~20 new files
- Maintainability: ğŸ”¼ Significantly improved
- IDE performance: ğŸ”¼ Improved

#### Phase 2: Expose Collection Objects (Medium Priority)

**Goal:** Expose `Documents`, `Windows` collections to match official API

**New API:**
```python
# Add to App class:
class App:
    @property
    def documents(self):
        """Access to IXHwpDocuments collection."""
        return DocumentsCollection(self.api)

    @property
    def windows(self):
        """Access to IXHwpWindows collection."""
        return WindowsCollection(self.api)

    @property
    def active_document(self):
        """Currently active document."""
        return Document(self.api.ActiveDocument)

# New collection classes:
class DocumentsCollection:
    def __init__(self, hwp_object):
        self._hwp = hwp_object

    def __len__(self):
        return self._hwp.Documents.Count

    def __getitem__(self, index):
        return Document(self._hwp.Documents.Item(index))

    def add(self):
        """Create new document."""
        return Document(self._hwp.Documents.Add())

class Document:
    def __init__(self, doc_com_object):
        self._doc = doc_com_object

    @property
    def full_name(self):
        return self._doc.FullName

    def save(self):
        return self._doc.Save()

    def close(self):
        return self._doc.Close()
```

**Usage:**
```python
app = App()

# Access collections:
print(f"Open documents: {len(app.documents)}")
doc1 = app.documents[0]
doc2 = app.documents[1]

# Multi-document workflows:
for doc in app.documents:
    print(doc.full_name)
    doc.save()

# Create new document:
new_doc = app.documents.add()
```

**Benefits:**
- Feature parity with official API
- Multi-document support
- More explicit than implicit "current document"
- Better for automation scripts

#### Phase 3: Add Form Controls Support (Low Priority)

**Goal:** Expose form controls for interactive documents

**New Classes:**
```python
# Add to App:
class App:
    @property
    def forms(self):
        """Access to form controls."""
        return FormsCollection(self.api)

class FormsCollection:
    def __init__(self, hwp_object):
        self._hwp = hwp_object

    @property
    def push_buttons(self):
        return PushButtonsCollection(self._hwp.Forms.PushButtons)

    @property
    def check_buttons(self):
        return CheckButtonsCollection(self._hwp.Forms.CheckButtons)

    # etc...
```

**Benefits:**
- Support form-based documents
- Enable interactive workflows
- Complete API coverage

---

### Restructuring Priorities (Updated)

| Priority | Task | Lines Saved | Complexity Reduction | User Impact |
|----------|------|-------------|---------------------|-------------|
| **1** | Split parametersets.py by domain | 0 (reorg) | ğŸ”¼ğŸ”¼ğŸ”¼ High | Low (internal) |
| **2** | Unify backend modes | ~200 | ğŸ”¼ğŸ”¼ Medium | Low (internal) |
| **3** | Expose Documents/Windows collections | +150 | ğŸ”½ Slight increase | ğŸ”¼ğŸ”¼ High (feature) |
| **4** | Consolidate property types | ~200 | ğŸ”¼ Medium | Low (internal) |
| **5** | Add Form controls support | +200 | ğŸ”½ Slight increase | ğŸ”¼ Medium (feature) |
| **6** | Remove forward declarations | ~25 | ğŸ”¼ Small | None |

**Recommendation:** Start with Priority 1 (split parametersets.py) as it has:
- Highest maintainability impact
- Zero breaking changes
- Easiest to implement (move code, update imports)

---

### Implementation Strategy

#### Step 1: Prepare New Structure (parametersets/ package)

1. Create directory structure:
   ```bash
   mkdir -p hwpapi/parametersets/{text,table,drawing,document,formatting,actions,forms}
   ```

2. Create `__init__.py` files with re-exports:
   ```python
   # hwpapi/parametersets/__init__.py
   from .base import ParameterSet, ParameterSetMeta
   from .backends import *
   from .properties import *
   from .text.character import CharShape, BulletShape
   from .text.paragraph import ParaShape, TabDef
   # ... (re-export all classes to preserve imports)

   __all__ = ['ParameterSet', 'CharShape', 'ParaShape', ...]  # Full list
   ```

3. Move classes to domain files:
   - Extract CharShape, BulletShape â†’ `text/character.py`
   - Extract ParaShape, TabDef â†’ `text/paragraph.py`
   - Continue for all 130+ classes

4. Update notebook:
   - Split `nbs/02_api/02_parameters.ipynb` into multiple notebooks:
     - `02_parameters_base.ipynb` â†’ `base.py`
     - `02_parameters_text_char.ipynb` â†’ `text/character.py`
     - etc.
   - Or keep single notebook with clear section markers

5. Test imports:
   ```python
   # Ensure backward compatibility:
   from hwpapi.parametersets import CharShape  # Should still work
   ```

#### Step 2: Document Migration

1. Update CLAUDE.md with new file mappings
2. Update README with new structure
3. Create migration guide for contributors

#### Step 3: Gradual Rollout

1. **Phase 1a**: Move base classes, backends, properties (low risk)
2. **Phase 1b**: Move text-related classes (medium risk)
3. **Phase 1c**: Move remaining classes (high risk, test thoroughly)
4. **Phase 1d**: Update documentation, examples

---

### Benefits Summary

**Immediate Benefits (Phase 1 - Reorganization):**
- âœ… **Navigability**: Find classes 10x faster
- âœ… **Maintainability**: Logical grouping by domain
- âœ… **Team Collaboration**: Fewer merge conflicts
- âœ… **IDE Performance**: Faster autocomplete
- âœ… **Code Reviews**: Easier to review focused changes
- âœ… **Zero Breaking Changes**: Backward compatible via re-exports

**Long-term Benefits (Phase 2-3 - New Features):**
- âœ… **API Completeness**: Match official HWP API surface
- âœ… **Multi-document Support**: Automate across multiple files
- âœ… **Form Support**: Interactive document automation
- âœ… **Better Alignment**: Official docs map directly to code structure

**Non-Goals:**
- âŒ Don't change the property descriptor system (it's excellent)
- âŒ Don't change the backend abstraction (it works well)
- âŒ Don't change the Actions pattern (pythonic and convenient)
- âŒ Don't add complexity for theoretical future needs

---

### Migration Checklist

When implementing the restructuring:

**Preparation:**
- [ ] Read official HwpAutomation_2504.pdf documentation
- [ ] Understand current parametersets.py organization
- [ ] Create domain-based file structure

**Phase 1 Execution:**
- [ ] Create `hwpapi/parametersets/` package structure
- [ ] Split notebooks (or keep single notebook with sections)
- [ ] Move base classes to `base.py`
- [ ] Move backend classes to `backends.py`
- [ ] Move property descriptors to `properties.py`
- [ ] Move mappings to `mappings.py`
- [ ] Move ParameterSet subclasses to domain files
- [ ] Create `__init__.py` with full re-exports
- [ ] Run `nbdev_export`
- [ ] Test all imports: `python -c "from hwpapi.parametersets import CharShape, ParaShape, Table"`
- [ ] Run full test suite: `python -m pytest tests/ -v`
- [ ] Update CLAUDE.md file mapping table
- [ ] Commit changes

**Phase 2 Execution (Optional):**
- [ ] Design DocumentsCollection, WindowsCollection classes
- [ ] Add `app.documents`, `app.windows` properties
- [ ] Write tests for multi-document workflows
- [ ] Update documentation with examples
- [ ] Commit changes

**Phase 3 Execution (Optional):**
- [ ] Design FormsCollection classes
- [ ] Add `app.forms` property
- [ ] Write tests for form controls
- [ ] Update documentation
- [ ] Commit changes

---

## ğŸ”„ Version History

### Recent Changes

**2025-01-08 - Architecture Analysis & Restructuring Plan**
- Analyzed official HWP Automation Object Model (HwpAutomation_2504.pdf)
- Compared official structure with current hwpapi implementation
- Identified 4 major gaps: Collection objects, monolithic parametersets.py, form controls, organization
- Designed 3-phase restructuring plan:
  - Phase 1: Split parametersets.py into domain-based modules (highest priority)
  - Phase 2: Expose Documents/Windows collections (medium priority)
  - Phase 3: Add Form controls support (low priority)
- Added comprehensive "HWP Object Model: Official vs Current Architecture" section to CLAUDE.md
- Result: Clear roadmap for better alignment with official API and improved maintainability

**2024 - Auto-Generated attributes_names**
- Removed manual `self.attributes_names = [...]` from 9+ classes
- Added `@property attributes_names` to ParameterSet
- Fixed `_del_value` to handle None backend
- Updated tests to use property descriptors
- Result: -500 lines, eliminated sync issues

**2024 - Added _is_com Function**
- Fixed NameError in `_looks_like_pset`
- Added proper COM object detection
- Now properly distinguishes COM vs non-COM objects

**Earlier - Pset Migration**
- See PSET_MIGRATION_SUMMARY.md
- Migrated from HSet-based to pset-based approach
- Maintained backward compatibility

---

## âœ… Checklist for New Contributors

Before making changes:
- [ ] Read this entire document
- [ ] Understand nbdev workflow (CRITICAL)
- [ ] Know the file mapping (notebook â†’ .py)
- [ ] Set up development environment
- [ ] Can run `nbdev_export` successfully
- [ ] Can run tests

Before committing:
- [ ] Edited notebook, NOT .py file
- [ ] Ran `nbdev_export`
- [ ] Ran tests (`python -m pytest tests/ -v`)
- [ ] Verified imports work
- [ ] Added/updated tests if needed
- [ ] Committing both .ipynb and .py files
- [ ] Commit message describes what and why

---

## ğŸ“ Quick Reference Commands

```bash
# Export notebooks to Python
nbdev_export

# Run all tests
python -m pytest tests/ -v

# Test specific module
python -m pytest tests/test_hparam.py -v

# Verify imports
python -c "import hwpapi; print('OK')"

# Check notebook validity
python -m nbformat.validate nbs/02_api/02_parameters.ipynb

# Generate documentation
nbdev_docs

# Clean generated files
nbdev_clean

# Preview documentation
nbdev_preview
```

---

## ğŸ¯ Remember

1. **This is nbdev**: Source is in notebooks, .py files are generated
2. **Backend abstraction works**: Trust `make_backend()` factory
3. **Properties are auto-registered**: No manual `attributes_names` needed
4. **Always check for None**: Backend might not be initialized
5. **Test your changes**: Don't break existing functionality
6. **Keep it simple**: Prefer simplification over clever abstractions
7. **Document decisions**: Update this file when you learn something new

---

*This document is a living guide. Update it as you learn more about the codebase.*

**Last Updated:** 2025-01-08 (After architecture analysis and restructuring plan)
**Next Review:** After Phase 1 restructuring (split parametersets.py by domain)
